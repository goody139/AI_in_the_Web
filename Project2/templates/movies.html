{% extends "flask_user_layout.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">


<div id="filterView"></div>

<br> 
<br>

<div class="dropdown">
    <button onclick="toggleDropdown('Genre')" class="dropbtn">Genre</button>
    <div id="myDropdownGenre" class="dropdown-content">
        <input type="text" placeholder="Search.." id="myInputGenre" onkeyup="filterFunction('Genre')">

            <select id="GenreDropdown" class="Selector" multiple>
            {% for genre in genre_list %}
                    <option name="selected_Genre" value="{{ genre }}"> {{ genre }} </option>
            {% endfor %}
            </select>
    </div>
</div>

{% if show_recommendation %}
<div class="dropdown">
    <button onclick="toggleDropdown('Algorithm')" class="dropbtn">Recommendation</button>
    <div id="myDropdownAlgorithm" class="dropdown-content">
        <input type="text" placeholder="Search.." id="myInputAlgorithm" onkeyup="filterFunction('Algorithm')">

            <select id="AlgorithmDropdown" class="Selector" multiple>
            {% set algorithm = ["Recommended for you", "Other users also liked", "Based on the movies you liked", "Most popular"] %}
            {% for i in algorithm %}
                    <option name="selected_Algorithm" value="{{ i }}"> {{ i }}</option>
            {% endfor %}
            </select>
    </div>
</div>
{% endif %}

<div class="dropdown">
    <button onclick="toggleDropdown('Tag')" class="dropbtn">Tags</button>
    <div id="myDropdownTag" class="dropdown-content">
        <input type="text" placeholder="Search.." id="myInputTag" onkeyup="filterFunction('Tag')">
        

            <select multiple id="TagDropdown" class="Selector">
            {% for tag in tag_list %}
                    <option name="selected_Tag" value="{{ tag }}"> {{ tag }} </option>
            {% endfor %}
            </select>
    </div>
</div>


{% if show_search %}
    <input style="color: black" type="text" data-title="{{ t_list }}" data-description="{{d_list}}" placeholder="Search.." id="myInputTitle">
{% endif %}

<br> 
<br> 

<button id="filter-form" onclick="ApplyFilter( {{user_id}} )">Apply filter options</button>




<div class="container sort-container">
    <div id="sort_mode_container">
        <input type="checkbox" id="sort_mode" name="sort_mode">
        <label id="sort_mode_label" for="sort_mode">Ascending</label>
    </div>
    <div class="select-wrapper">
        <label for="select">Sort by</label>
        <select id="sort_by" name="sort_by">
            <option value="default">Default</option>
            <option value="release_date">Release date</option>
            <option value="runtime">Runtime</option>
            <option value="mean_rating">Mean rating</option>
            <option value="title">Title</option>
            <option value="probabilities">Match probability</option>
        </select>
    </div>
</div>
  

<div id="movie_list" class="container">
    {% for m,tags,rating,watchlisted,avg_rating,probability in movies_and_tags %}
        <div class="panel">
            
            <div class="panel-heading">
                <div class="watchlist pull-left">
                    {% if watchlisted%}
                    <a href="#" class="card-link" data-movieid="{{ m.id }}" data-status="0">♥</a>
                    {% else %}
                    <a href="#" class="card-link" data-movieid="{{ m.id }}" data-status="0">♡</a>
                    {% endif %}
                </div>
                <div class="panel-title pull-left"><b><a href="{{ url_for('movie', id=m.id) }}">{{ m.title }}</a></b></div>
                <div class="match-probability"><b>{{probability}}% Match</b></div>

                {% for l in m.links %}
                    <div class="db-links pull-right">
                        <a href=https://movielens.org/movies/{{ l.movie_id }}>
                            <img src="{{ url_for('static', filename='movielens-logo-white.svg') }}" alt="Movielens"> 
                        </a>
                        <a href=http://www.imdb.com/title/tt{{ l.imdb_id }}>
                            <img src="{{ url_for('static', filename='IMDb.png') }}" alt="IMDb">
                        </a>
                        <a href=https://www.themoviedb.org/movie/{{ l.tmdb_id}}>
                            <img src="{{ url_for('static', filename='TMDB.png') }}" alt="TMDB">
                        </a>
                    </div>
                {% endfor %}

                <div class="clearfix"></div>
            </div>
            <div class="panel-body">
                
                <img src="{{ m.poster_path }}"/>

                <div class="movie-information">    
                    <p>{{m.blurb}}</p>

                    <br>
                    <p>
                        {% for g in m.genres %}
                            <span class="label label-genre">{{ g.genre }}</span>
                        {% endfor %}
                    </p>
                    <p>
                        {% for t in tags %}
                            <span class="label label-tag">{{ t }}</span>
                        {% endfor %}
                    </p>
                    
                    {% if m.runtime %}
                    <p>
                        <b>Runtime: {{ m.runtime }} minutes</b>
                    </p>
                    {% endif %}

                    {% if m.reviews %}
                    <div class="review-container">
                        <div class="review-header"> Reviews</div>
                        
                        <div class="picture-text">
                            {% for r in m.reviews %}
                            <div class="review-container"> 
                                {% markdown %}
                                {{r.review }}
                                {% endmarkdown %}       
                                
                            </div> <!-- review-container -->
                            {% endfor %}
                        </div> <!-- picture-text -->
                    </div> <!-- review-container -->
                    {% endif %}

                </div> <!-- movie-information -->       
            </div> <!-- panel-body -->

            {% if rating %}
            <div class="panel-footer">
                <div class="movie-rating">Rated:
                {% for i in range(1, rating+1) %}
                <a href="#" id="{{ m.id }}{{ i }}" class="card-link" data-movieid="{{ m.id }}" data-rating="{{ i }}">⭐</a>
                {% endfor %}
                {% for i in range(rating+1, 5+1) %}
                <a href="#" id="{{ m.id }}{{ i }}" class="card-link" data-movieid="{{ m.id }}" data-rating="{{ i }}">☆</a>
                {% endfor %} Stars
                </div>
                
                <div class="average-rating">
                    Average rating: {{ avg_rating }}
                </div>
            </div>
            {% else %}
            <div class="panel-footer">
                <div class="movie-rating">Rate:
                <a href="#" id="{{m.id}}1" class="card-link" data-movieid="{{ m.id }}" data-rating="1">☆</a>
                <a href="#" id="{{m.id}}2" class="card-link" data-movieid="{{ m.id }}" data-rating="2">☆</a>
                <a href="#" id="{{m.id}}3" class="card-link" data-movieid="{{ m.id }}" data-rating="3">☆</a>
                <a href="#" id="{{m.id}}4" class="card-link" data-movieid="{{ m.id }}" data-rating="4">☆</a>
                <a href="#" id="{{m.id}}5" class="card-link" data-movieid="{{ m.id }}" data-rating="5">☆</a> Stars
                </div>

                <div class="average-rating">
                    Average rating: {{ avg_rating }}
                </div>
            </div>
            {% endif %}
        </div>
    {% endfor %}
</div>

{% if show_more_enabled %}
    <button id="show-more">Show more</button>
{% endif %}

<script>
    var selectedOptions = {};
    const sort_checkbox = document.getElementById("sort_mode");
    const sort_label = document.getElementById("sort_mode_label");
    var movie_list = document.getElementById("movie_list");
    const sort_by = document.getElementById("sort_by");
    var filter_text = document.getElementById('filter_text');


    // Function to handle the click event on any rating link
    function rateMovie(event) {
        event.preventDefault(); // Prevent the default anchor action

        var movieid = this.getAttribute('data-movieid');
        var rating = this.getAttribute('data-rating');
        var elem = this;

        // Create an AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/rating', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Handle the response
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                elem.parentElement.innerHTML = xhr.responseText;
                // Attach the event listener to each rating link
                var links = document.querySelectorAll('.movie-rating .card-link');
                for (var i = 0; i < links.length; i++) {
                    links[i].addEventListener('click', rateMovie);
                }
            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        // Send the request with the movie ID and the rating
        xhr.send('m=' + movieid + '&r=' + rating);
    }

    function updateRatingView(event) {
        event.preventDefault(); // Prevent the default anchor action

        var movieid = this.getAttribute('data-movieid');
        var rating = this.getAttribute('data-rating');
        var elem = this;

        // Create an AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/ratings', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Handle the response
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                elem.parentElement.innerHTML = xhr.responseText;
                // Attach the event listener to each rating link
                var links = document.querySelectorAll('.movie-rating .card-link');
                for (var i = 0; i < links.length; i++) {
                    links[i].addEventListener('click', rateMovie);
                    if(links[i].id!=elem.id) {
                        links[i].addEventListener("mouseenter", updateRatingView);
                    }
                }
            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        // Send the request with the movie ID and the rating
        xhr.send('m=' + movieid + '&r=' + rating);
    }

    function changeWatchlist(event) {
        event.preventDefault(); // Prevent the default anchor action

        var movieid = this.getAttribute('data-movieid');
        var current_status = this.getAttribute('data-status');
        var elem = this;

        // Create an AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/watchlist_change', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        // Handle the response
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                elem.parentElement.innerHTML = xhr.responseText;
                // Attach the event listener to each rating link
                var links = document.querySelectorAll('.watchlist .card-link');
                for (var i = 0; i < links.length; i++) {
                    links[i].addEventListener('click', changeWatchlist);
                }
            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        // Send the request with the movie ID and the rating
        xhr.send('m=' + movieid);
    }

    function reverseChildren(parent) {
        for (var i = 1; i < parent.childNodes.length; i++){
            parent.insertBefore(parent.childNodes[i], parent.firstChild);
        }
    }

    function updateFilterView() {
        console.log("filterview function")
        var filterView = document.getElementById('filterView');
        filterView.innerHTML = ''; // Cle8ar previous content
    
        Object.keys(selectedOptions).forEach(function (category) {
    
            var values = selectedOptions[category];
            console.log("the values" + values)
    
            values.forEach(function (value) {
                var filterOption = document.createElement('div');
                filterOption.className = 'filterOption';
                filterOption.textContent = value;
                filterOption.name = category; 
                filterView.appendChild(filterOption);
                filterOption.onclick = function() {
                    // Handle selection of options 
                    var name = this.name; 
                    var value = this.textContent;
    
                    // Handle FilterView 
                    option = document.querySelector('option[value="'+value+'"][name="selected_'+name+'"]');  
                    option.selected = !option.selected;
                    this.remove();
                    list = selectedOptions[category]
                    if (list.includes(value)){
                        list.splice(list.indexOf(value),1)
                    }
    
                };
            });
        });
    }
    
    function getSelectedValues(selectId) {
        var selectedOptions = document.getElementById(selectId).selectedOptions;
        var values = [];

        for (var i = 0; i < selectedOptions.length; i++) {
            values.push(selectedOptions[i].value);
        }

        return values;
    }
    
    function toggleDropdown(category) {
        document.getElementById("myDropdown"+category).classList.toggle("show");
    }

    function filterFunction(category) {
        var input, filter, div, optionList, i;
        //console.log("myInput"+category);
        input = document.getElementById("myInput"+category);
        filter = input.value.toUpperCase();
        div = document.getElementById("myDropdown"+category);
        optionList = div.getElementsByTagName("option");
        var matchedElements = [];

        for (i = 0; i < optionList.length; i++) {
            var txtValue = optionList[i].textContent || optionList[i].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                console.log("other")
                optionList[i].style.display = "";
                matchedElements.push(optionList[i]); 
            } else {
                optionList[i].style.display = "none";
            }
            
        }

    }   
    
    function getSelectedValue(selector) {
        var selectedOptions = document.querySelectorAll(selector + ':checked');
        var values = [];
    
    
        if (selectedOptions.length == 0) {
            console.log("empty option")
            return '0';
        }
        // Check if a checked option exists
        else {
            selectedOptions.forEach(function (option) {
                values.push(option.value);
            });
            
            console.log(values)
            return values;
        } 
    
    }

    function ApplyFilter(user_id){
        // code sowas wie wenn null oder mit if nacch checked suchen 
        console.debug("FILTER BUTTON PRESSED")
        var filter_button = document.getElementById('filter-form');
        
        filter_button.disabled = true;
        filter_button.style.color = "#1e1e1e"
        filter_button.textContent = "Filtering...";

        var tag = getSelectedValue('option[name="selected_Tag"]');
        var genre = getSelectedValue('option[name="selected_Genre"]');
        {% if show_recommendation %}
        var algorithm = getSelectedValue('option[name="selected_Algorithm"]');
        {% endif %}
        var allFilters = getSelectedValue('option[name="all_filters"]');
        
        // selected options der titel in dem moment speichern zu der liste in der gesucht wird 
        // das sind dann nicht selected ones, sondern müssen die sein, die gefiltert werden in dem Moment 
        // wie löschen (mehrere items) wenn option weggeklickt wird dictionary? item keys konstrukt 

        console.debug("GET VALUES");
        console.debug(tag, genre, algorithm, allFilters);

        var request_parameters = 'type=' + window.location.pathname.substring(1);
        var have_something_to_filter = false;

        if (genre != '0') {
            request_parameters += '&genres=' + genre;
            have_something_to_filter = true;
        }

        if (tag != '0') {
            request_parameters += '&tags=' + tag;
            have_something_to_filter = true;
        }

        {% if show_recommendation %}
        if (algorithm != '0') {
            request_parameters += '&algorithm=' + algorithm;
            have_something_to_filter = true;
        }
        {% endif %}

        if (have_something_to_filter) {
            // Use Fetch to asynchronously send the rating to the server
            var parameters = window.location.search;
            parameters = parameters.replace('?','&');
            fetch('/filter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: request_parameters + "&" + parameters
            })
            .then(response => {
                if (!response.ok) {
                    filter_button.disabled = false;
                    filter_button.style.color = "black"
                    filter_button.textContent = "Apply filters";
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                filter_button.disabled = false;
                filter_button.style.color = "black"
                filter_button.textContent = "Apply filters";
                //window.history.pushState('page2', 'Title', "?" + request_parameters + parameters);
                if (typeof show_more_button !== 'undefined'){
                    show_more_button.style.visibility = "hidden"
                }
                
                setInnerHTML(movie_list, data);
                movie_list = document.getElementById("movie_list");
                
                console.log(data); // Process the server response here
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }
    }

    var number_of_result_pages_shown = 1;

{% if show_more_enabled %}
    var show_more_button = document.getElementById('show-more');
    show_more_button.addEventListener("click", function() {
        event.preventDefault(); // Prevent the default anchor action
        show_more_button.disabled = true;
        show_more_button.style.color = "#1e1e1e";

        // Create an AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/load-more-results', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        var parameters = window.location.search;
        parameters = parameters.replace('?','&');
        console.log(parameters);

        // Handle the response
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                //appendInnerHTML(movie_list, xhr.responseText);
                console.log("hello");
                movie_list.insertAdjacentHTML('beforeend', xhr.responseText);
                
                let parser = new DOMParser();
                const doc = parser.parseFromString(xhr.responseText, 'text/html');
                scripts = doc.getElementsByTagName('script');
                var arrayScriptContents = [].map.call(scripts, function(el) {
                    var new_script = document.createElement('script');
                    new_script.textContent = el.textContent;
                    document.body.appendChild(new_script);
                    console.log(el.textContent);
                    return el.textContent;
                });

                    
                
                if(typeof new_movie_ids !== 'undefined') {
                    movie_ids = movie_ids.concat(new_movie_ids);
                    new_movie_ids = movie_ids;
                    console.log(movie_ids);
                }
                if(typeof new_probabilities !== 'undefined') {
                    probabilities = probabilities.concat(new_probabilities);
                    new_probabilities = probabilities;
                    console.log(probabilities);
                }
                
                console.log("hello1");
                //movie_list.innerHTML = xhr.responseText;
                // movie_list = document.getElementById("movie_list");
                number_of_result_pages_shown += 1;
                show_more_button.disabled = false;
                show_more_button.style.color = "black";

            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        // Send the request with the selected sorting method
        xhr.send('type=' + window.location.pathname + '&page=' + number_of_result_pages_shown + '&movie_ids=' + movie_ids + '&probabilities=' + probabilities + parameters);
    });
{% endif %}   

    // Attach event listeners for each category
    {% if show_recommendation %}
    var categories = ["Tag", "Genre", "Algorithm"];
    {% else %}
    var categories = ["Tag", "Genre"];
    {% endif %}

    categories.forEach(function (category) {
        var selectId = category + 'Dropdown';
        selectedOptions[category] = getSelectedValues(selectId);

        var categoryDropdown = document.getElementById(category + 'Dropdown');

        document.getElementById(selectId).addEventListener('change', function () {
            selectedOptions[category] = getSelectedValues(selectId);
            updateFilterView();
        });

        categoryDropdown.addEventListener('mousedown', function (event) {
            event.preventDefault();
            updateFilterView();

            var originalScrollTop = this.scrollTop;
            
            if (category == "Algorithm"){
                limit_number = 0;
            } 

            else{
                limit_number = 2; 
            }
            
            // if option is clicked make it unselected
            if (event.target.selected == true){
                event.target.selected = !event.target.selected;
                selectedOptions[category] = getSelectedValues(selectId);
            }

            // if option is unselected ... 
            else if (event.target.selected == false){
                if (selectedOptions[category].length <= limit_number ){
                    event.target.selected = !event.target.selected;
                    selectedOptions[category] = getSelectedValues(selectId);
                }
            };

            setTimeout(() => {
                this.scrollTop = originalScrollTop;
            }, 0);

            this.focus();
            updateFilterView();
    });

        categoryDropdown.addEventListener('mousemove', function (event) {
            event.preventDefault();
        });
    });

    // Initial update
    updateFilterView();

    // pass the ids of the shown movies to pass to called functions for sorting
    var movie_ids = {{ movie_ids|safe }};
    var probabilities = {{ probabilities|safe }};


    // Attach the event listener to each rating link
    var links = document.querySelectorAll('.movie-rating .card-link');
    for (var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', rateMovie);
        links[i].addEventListener("mouseenter", updateRatingView);
    }

    var links = document.querySelectorAll('.watchlist .card-link');
    for (var i = 0; i < links.length; i++) {
        links[i].addEventListener('click', changeWatchlist);
    }    
    

    // attach the listener to the check box for sorting ascending / descending
    sort_checkbox.addEventListener("change", () => {
        if (sort_checkbox.checked) {
            sort_label.textContent = "Descending";
            reverseChildren(movie_list);
        } else {
            sort_label.textContent = "Ascending";
            reverseChildren(movie_list);
        }
    });


    // this function was taken from an answer on StackOverflow from user allenhwkim: https://stackoverflow.com/a/47614491
    
    function setInnerHTML(elm, html) {
        elm.innerHTML = html;
        
        Array.from(elm.querySelectorAll("script"))
            .forEach( oldScriptEl => {
            const newScriptEl = document.createElement("script");
            
            Array.from(oldScriptEl.attributes).forEach( attr => {
                newScriptEl.setAttribute(attr.name, attr.value) 
            });
            
            const scriptText = document.createTextNode(oldScriptEl.innerHTML);
            newScriptEl.appendChild(scriptText);
            
            oldScriptEl.parentNode.replaceChild(newScriptEl, oldScriptEl);
        });
    }

    function appendInnerHTML(elm, html) {
        elm.innerHTML = html;
        
        Array.from(elm.querySelectorAll("script"))
            .forEach( oldScriptEl => {
            const newScriptEl = document.createElement("script");
            
            Array.from(oldScriptEl.attributes).forEach( attr => {
                newScriptEl.setAttribute(attr.name, attr.value) 
            });
            
            const scriptText = document.createTextNode(oldScriptEl.innerHTML);
            newScriptEl.appendChild(scriptText);
            
            oldScriptEl.parentNode.append(newScriptEl, oldScriptEl);
        });
    }

    // attach listener to select for changing the thing to sort by
    sort_by.addEventListener("change", () => {
        // make a request to call a python function that takes care of the sorting
        // so that the movies part can be rendered again

        event.preventDefault(); // Prevent the default anchor action

        var sort_by_value = sort_by.options[ sort_by.selectedIndex ].value;

        // Create an AJAX request
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/sort_by', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        var parameters = window.location.search;
        parameters = parameters.replace('?','&');

        // Handle the response
        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                setInnerHTML(movie_list, xhr.responseText);
                //movie_list.innerHTML = xhr.responseText;
                movie_list = document.getElementById("movie_list");

            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        if(typeof new_movie_ids !== 'undefined') {
            movie_ids = new_movie_ids;
            console.log(movie_ids);
        }
        if(typeof new_probabilities !== 'undefined') {
            probabilities = new_probabilities;
            console.log(probabilities);
        }
        // Send the request with the selected sorting method
        xhr.send('s=' + sort_by_value + '&type=' + window.location.pathname + '&movie_ids=' + movie_ids + '&probabilities=' + probabilities + parameters);

        
    });

{% if show_search %}
    var searchBar = document.getElementById('myInputTitle');
    // Event-Listener hinzufügen
    searchBar.addEventListener('keyup', function (event) {
        // input in filterview einfügen 
        if (event.keyCode === 13) {
        //if(! selectedOptions["Title"].includes(searchBar.value) && selectedOptions["Title"].length <= 2){
        //selectedOptions["Title"].push(searchBar.value)
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/searchbar', true);
        xhr.setRequestHeader('Content-Type', 'application/json'); // Set Content-Type to application/json
        // Convert the list of objects to JSON
        console.log(SVGAElement)
        console.log(searchBar.value)
        //var jsonPayload = JSON.stringify(Searchbar_matches);
        var jsonPayload = JSON.stringify(searchBar.value);

        xhr.onload = function() {
            if (xhr.status === 200) {
                // Replace the entire div with the response
                movie_list.innerHTML = xhr.responseText;
                // Attach the event listener to each rating link
                var links = document.querySelectorAll('.movie-rating .card-link');
                for (var i = 0; i < links.length; i++) {
                    links[i].addEventListener('click', rateMovie);
                }
            } else {
                alert('Request failed. Returned status of ' + xhr.status);
            }
        };

        xhr.send(jsonPayload);
        Searchbar_matches = []; 

        }
    });
{% endif %}



</script>

{% endblock %}
